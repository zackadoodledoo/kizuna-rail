<%- include('../partials/header') %>
<article class="booking-page">
    <div class="route-header">
        <div class="route-header-content">
            <h1 class="route-name"><%= title %></h1>
            <p class="route-description">Complete your booking details below.</p>
        </div>
    </div>

    <form class="booking-form" method="POST" action="/routes/book">
        <input type="hidden" name="scheduleId" value="<%= schedule.id %>">
        <input type="hidden" name="routeId" value="<%= schedule.routeId %>">

        <section class="ticket-selection">
            <h2 class="section-title">Select Your Ticket</h2>
            
            <div class="ticket-options">
                <% if (ticketOptions) { %>
                    <% ticketOptions.forEach((ticket, index) => { %>
                        <label class="ticket-card" for="ticket-<%= ticket.class %>">
                            <input 
                                type="radio" 
                                name="ticketClass" 
                                id="ticket-<%= ticket.class %>" 
                                value="<%= ticket.class %>"
                                data-name="<%= ticket.name %>"
                                data-price="<%= ticket.price %>"
                                <%= index === 1 ? 'checked' : '' %>
                                required
                            >
                            <div class="ticket-content">
                                <div class="ticket-header">
                                    <h3 class="ticket-name"><%= ticket.name %></h3>
                                    <div class="ticket-price">
                                        <span class="price-symbol">¥</span>
                                        <span class="price-amount"><%= Number(ticket.price).toLocaleString() %></span>
                                    </div>
                                </div>
                                
                                <p class="ticket-description"><%= ticket.description %></p>
                                
                                <ul class="amenities-list">
                                    <% if (ticket.amenities) { %>
                                        <% ticket.amenities.forEach((amenity) => { %>
                                            <li class="amenity-item">
                                                <span class="amenity-icon">✓</span>
                                                <span class="amenity-text"><%= amenity %></span>
                                            </li>
                                        <% }) %>
                                    <% } %>
                                </ul>
                            </div>
                        </label>
                    <% }) %>
                <% } %>
            </div>
        </section>

        <section class="day-selection">
            <h2 class="section-title">Select The Day</h2>
            
            <div class="schedule-info">
                <div class="time-display">
                    <span class="departure-time"><%= schedule.departureTime %></span>
                    <span class="time-separator">→</span>
                    <span class="arrival-time"><%= schedule.arrivalTime %></span>
                </div>
                <div class="days-display">
                    <% if (schedule && schedule.daysOfWeek) { %>
                        <% schedule.daysOfWeek.forEach((day, index) => { %>
                            <label class="day-pill<%= index === 0 ? ' selected' : '' %>" for="day-<%= index %>">
                                <input
                                    type="radio"
                                    name="selectedDay"
                                    id="day-<%= index %>"
                                    value="<%= day %>"
                                    <%= index === 0 ? 'checked' : '' %>
                                    required
                                >
                                <span class="day-text"><%= day %></span>
                            </label>
                        <% }) %>
                    <% } %>
                </div>
            </div>
        </section>

        <section class="passengers-section">
            <div class="passengers-header">
                <h2 class="section-title">Passenger Details</h2>
                <button type="button" class="btn-add-passenger" id="addPassenger">
                    <span class="add-icon">+</span>
                    Add Passenger
                </button>
            </div>

            <div id="passengersList" class="passengers-list">
                <!-- First passenger added by default -->
                <div class="passenger-card" data-passenger-index="0">
                    <div class="passenger-card-header">
                        <h3 class="passenger-number">Passenger 1</h3>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="firstName-0" class="form-label">First Name</label>
                            <input 
                                type="text" 
                                id="firstName-0" 
                                name="passengers[0][firstName]" 
                                class="form-input" 
                                required
                                placeholder="Enter first name"
                            >
                        </div>

                        <div class="form-group">
                            <label for="lastName-0" class="form-label">Last Name</label>
                            <input 
                                type="text" 
                                id="lastName-0" 
                                name="passengers[0][lastName]" 
                                class="form-input" 
                                required
                                placeholder="Enter last name"
                            >
                        </div>

                        <div class="form-group">
                            <label for="email-0" class="form-label">Email Address</label>
                            <input 
                                type="email" 
                                id="email-0" 
                                name="passengers[0][email]" 
                                class="form-input" 
                                required
                                placeholder="your.email@example.com"
                            >
                        </div>

                        <div class="form-group">
                            <label for="phone-0" class="form-label">Phone Number</label>
                            <input 
                                type="tel" 
                                id="phone-0" 
                                name="passengers[0][phone]" 
                                class="form-input" 
                                required
                                placeholder="+81 90-1234-5678"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <p class="passenger-limit-note">Maximum 8 passengers per online booking. Please call to schedule larger groups. ( <a href="#" id="autofill">Click Here to Auto Fill Form</a> )</p>
        </section>

        <section class="booking-summary">
            <h2 class="section-title">Booking Summary</h2>

            <div class="summary-content">
                <div class="summary-row">
                    <span class="summary-label">Selected Ticket:</span>
                    <span class="summary-value" id="selectedTicketName"><%= ticketOptions && ticketOptions[0] ? ticketOptions[0].name : 'Standard Class' %></span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Number of Passengers:</span>
                    <span class="summary-value" id="passengerCount">1</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Price per Ticket:</span>
                    <span class="summary-value" id="pricePerTicket"><%= ticketOptions && ticketOptions[0] ? '¥' + Number(ticketOptions[0].price).toLocaleString() : '¥14,400' %></span>
                </div>
                <div class="summary-row total">
                    <span class="summary-label">Total Amount:</span>
                    <span class="summary-value" id="totalAmount"><%= ticketOptions && ticketOptions[0] ? '¥' + Number(ticketOptions[0].price).toLocaleString() : '¥14,400' %></span>
                </div>
            </div>
        </section>

        <div class="form-actions">
            <a href="/routes/<%= schedule.routeId %>" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Confirm Booking</button>
        </div>
    </form>
</article>

<script>
    const maxPassengers = 8;
    let passengerCount = 1;
    let ticketPrice = 0;

    const selectedDayLabels = document.querySelectorAll('.days-display label');
    const passengersList = document.getElementById('passengersList');
    const addPassengerBtn = document.getElementById('addPassenger');
    const ticketRadios = document.querySelectorAll('input[name="ticketClass"]');
    
    // Update summary displays
    const selectedTicketName = document.getElementById('selectedTicketName');
    const passengerCountDisplay = document.getElementById('passengerCount');
    const pricePerTicket = document.getElementById('pricePerTicket');
    const totalAmount = document.getElementById('totalAmount');

    const updateSummary = () => {
        passengerCountDisplay.textContent = passengerCount;
        pricePerTicket.textContent = `¥${ticketPrice.toLocaleString()}`;
        const total = ticketPrice * passengerCount;
        totalAmount.textContent = `¥${total.toLocaleString()}`;
    };

    const updatePassengerNumbers = () => {
        const cards = document.querySelectorAll('.passenger-card');
        cards.forEach((card, index) => {
            card.querySelector('.passenger-number').textContent = `Passenger ${index + 1}`;
        });
    };

    const createRemoveButton = () => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-remove-passenger';
        btn.innerHTML = '<span class="remove-icon">×</span>';
        btn.setAttribute('aria-label', 'Remove passenger');
        return btn;
    };

    const addPassenger = () => {
        if (passengerCount >= maxPassengers) {
            alert(`Maximum of ${maxPassengers} passengers allowed per booking`);
            return;
        }

        const passengerCard = document.createElement('div');
        passengerCard.className = 'passenger-card';
        passengerCard.setAttribute('data-passenger-index', passengerCount);

        passengerCard.innerHTML = `
            <div class="passenger-card-header">
                <h3 class="passenger-number">Passenger ${passengerCount + 1}</h3>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="firstName-${passengerCount}" class="form-label">First Name</label>
                    <input 
                        type="text" 
                        id="firstName-${passengerCount}" 
                        name="passengers[${passengerCount}][firstName]" 
                        class="form-input" 
                        required
                        placeholder="Enter first name"
                    >
                </div>

                <div class="form-group">
                    <label for="lastName-${passengerCount}" class="form-label">Last Name</label>
                    <input 
                        type="text" 
                        id="lastName-${passengerCount}" 
                        name="passengers[${passengerCount}][lastName]" 
                        class="form-input" 
                        required
                        placeholder="Enter last name"
                    >
                </div>

                <div class="form-group">
                    <label for="email-${passengerCount}" class="form-label">Email Address</label>
                    <input 
                        type="email" 
                        id="email-${passengerCount}" 
                        name="passengers[${passengerCount}][email]" 
                        class="form-input" 
                        required
                        placeholder="your.email@example.com"
                    >
                </div>

                <div class="form-group">
                    <label for="phone-${passengerCount}" class="form-label">Phone Number</label>
                    <input 
                        type="tel" 
                        id="phone-${passengerCount}" 
                        name="passengers[${passengerCount}][phone]" 
                        class="form-input" 
                        required
                        placeholder="+81 90-1234-5678"
                    >
                </div>
            </div>
        `;

        const removeBtn = createRemoveButton();
        passengerCard.querySelector('.passenger-card-header').appendChild(removeBtn);

        passengersList.appendChild(passengerCard);
        passengerCount++;

        updateSummary();
        updateAddButtonState();
        addRemoveAllButtons();
    };

    const removePassenger = (card) => {
        if (passengerCount <= 1) {
            alert('At least one passenger is required');
            return;
        }

        card.remove();
        passengerCount--;
        
        updatePassengerNumbers();
        updateSummary();
        updateAddButtonState();
        addRemoveAllButtons();
    };

    const updateAddButtonState = () => {
        if (passengerCount >= maxPassengers) {
            addPassengerBtn.disabled = true;
            addPassengerBtn.classList.add('disabled');
        } else {
            addPassengerBtn.disabled = false;
            addPassengerBtn.classList.remove('disabled');
        }
    };

    const addRemoveAllButtons = () => {
        const firstCard = document.querySelector('.passenger-card');
        const existingBtn = firstCard.querySelector('.btn-remove-passenger');
        
        if (passengerCount > 1 && !existingBtn) {
            const removeBtn = createRemoveButton();
            firstCard.querySelector('.passenger-card-header').appendChild(removeBtn);
        } else if (passengerCount === 1 && existingBtn) {
            existingBtn.remove();
        }
    };

    const autoFillForm = () => {
        const westernFirstNames = ['James', 'Olivia', 'William', 'Emily', 'Charlotte', 'George', 'Anna', 'Henry'];
        const westernLastNames = ['Smith', 'Johnson', 'Brown', 'Taylor', 'Wilson', 'Evans', 'Clark', 'Davis'];
        
        const japaneseFirstNames = ['Yuki', 'Haruto', 'Sakura', 'Akira', 'Hana', 'Kenji', 'Aoi', 'Takeshi'];
        const japaneseLastNames = ['Tanaka', 'Suzuki', 'Yamamoto', 'Watanabe', 'Ito', 'Nakamura', 'Kobayashi', 'Sato'];
        
        const randomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        const cards = document.querySelectorAll('.passenger-card');
        
        cards.forEach((card, index) => {
            const i = card.dataset.passengerIndex ? Number(card.dataset.passengerIndex) : index;
            
            // 30% chance for Japanese name
            const isJapanese = Math.random() < 0.30;
            const firstName = randomItem(isJapanese ? japaneseFirstNames : westernFirstNames);
            const lastName = randomItem(isJapanese ? japaneseLastNames : westernLastNames);
            
            const firstNameInput = card.querySelector(`#firstName-${i}`);
            const lastNameInput = card.querySelector(`#lastName-${i}`);
            const emailInput = card.querySelector(`#email-${i}`);
            const phoneInput = card.querySelector(`#phone-${i}`);
            
            if (firstNameInput) firstNameInput.value = firstName;
            if (lastNameInput) lastNameInput.value = lastName;
            if (emailInput) {
                emailInput.value = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${randInt(10, 99)}@example.com`;
            }
            if (phoneInput) {
                if (isJapanese) {
                    // Japanese fictional: using 0120 (toll-free, safe for testing)
                    phoneInput.value = `+81 120-${randInt(100, 999)}-${randInt(1000, 9999)}`;
                } else if (Math.random() < 0.5) {
                    // US fictional: 555-01xx
                    phoneInput.value = `+1 555-01${String(randInt(10, 99)).padStart(2, '0')}-${randInt(1000, 9999)}`;
                } else {
                    // UK fictional: 01632
                    phoneInput.value = `+44 1632 960${String(randInt(100, 999))}`;
                }
            }
        });
        
        console.log(`✓ Filled ${cards.length} passenger form(s)`);
    };

    // Event Listeners
    selectedDayLabels.forEach((label) => {
        label.addEventListener('click', (e) => {
            e.preventDefault();
            const label = e.currentTarget;

            // Update visual and input selection
            selectedDayLabels.forEach((lbl) => {
                lbl.classList.remove('selected');
                lbl.querySelector('input').checked = false;
                lbl.querySelector('input').removeAttribute('checked');
            });

            label.classList.add('selected');
            label.querySelector('input').checked = true;
            label.querySelector('input').setAttribute('checked', true);
        });
    });

    addPassengerBtn.addEventListener('click', addPassenger);

    passengersList.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.btn-remove-passenger');
        if (removeBtn) {
            const card = removeBtn.closest('.passenger-card');
            removePassenger(card);
        }
    });

    ticketRadios.forEach((radio) => {
        radio.addEventListener('change', (e) => {
            e.preventDefault();
            const selected = e.currentTarget;

            // Update visual and input selection
            ticketRadios.forEach((input) => {
                input.checked = false;
                input.removeAttribute('checked');
            });

            selected.checked = true;
            selected.setAttribute('checked', true);

            // Update summary
            const ticketName = e.target.dataset.name;
            ticketPrice = parseInt(e.target.dataset.price);
            
            selectedTicketName.textContent = ticketName;
            updateSummary();
        });
    });

    document.getElementById('autofill').addEventListener('click', (e) => {
        e.preventDefault();
        autoFillForm();
    });

    // Initialize ticket based on default selection
    const selectedRadio = document.querySelector('input[name="ticketClass"]:checked');
    if (selectedRadio) {
        const ticketName = selectedRadio.dataset.name;
        selectedTicketName.textContent = ticketName;
        ticketPrice = parseInt(selectedRadio.dataset.price);
    }
    updateSummary();
</script>

<%- include('../partials/footer') %>